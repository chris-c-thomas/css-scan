#!/usr/bin/env node
import{render as D}from"ink";import O from"meow";import{useState as C,useEffect as A}from"react";import{Text as r,Box as a,useApp as P}from"ink";import I from"ink-spinner";import M from"ink-text-input";import{chromium as E}from"playwright";import T from"fs/promises";import v from"path";import*as F from"prettier";var b=[{width:1920,height:1080,label:"Desktop (1920x1080)"},{width:768,height:1024,label:"Tablet (768x1024)"},{width:375,height:667,label:"Mobile (375x667)"}];function N(l){return l.replace(/\s*([{}])\s*/g,` $1
`).replace(/;\s*/g,`;
  `).replace(/\s*{\s*/g,` {
  `).replace(/\n\s*}\s*/g,`
}
`).replace(/,\s*/g,", ").replace(/\n\s*\n/g,`
`)}async function y(l,d,o=""){let c=0;for(let s of d)s==="{"&&c++,s==="}"&&c--;let e=d;for(;c>0;)e+=`}
`,c--;for(;c<0;)e=`{
`+e,c++;o&&(e=o+e);let u=v.resolve(process.cwd(),l);try{let s=await F.format(e,{parser:"css"});await T.writeFile(u,s,"utf-8")}catch{let g=N(e);await T.writeFile(u,g,"utf-8")}return l}async function R(l){let d=await E.launch({headless:!0});try{let o=await d.newPage();await o.coverage.startCSSCoverage({resetOnNavigation:!1});for(let n of b)await o.setViewportSize(n),n===b[0]&&await o.goto(l,{waitUntil:"networkidle",timeout:3e4}),await o.waitForTimeout(500),await o.evaluate(()=>window.scrollTo(0,document.body.scrollHeight)),await o.waitForTimeout(200),await o.evaluate(()=>window.scrollTo(0,0));let c=await o.coverage.stopCSSCoverage(),e=0,u=0,s="",g="";for(let n of c){if(!n.text)continue;let S=n.text.length;e+=S;let w=0;for(let f of n.ranges)u+=f.end-f.start,f.start>w&&(g+=n.text.slice(w,f.start)+`
`),s+=n.text.slice(f.start,f.end)+`
`,w=f.end;w<S&&(g+=n.text.slice(w,S)+`
`)}let m=await y("used.css",s,`/* used.css generated by css-scan */
`),x=await y("unused.css",g,`/* unused.css generated by css-scan */
`),h=e-u,p=e>0?(h/e*100).toFixed(2):"0";return{url:l,totalBytes:e,usedBytes:u,unusedBytes:h,unusedPercentage:p,scannedViewports:b.map(n=>n.label),outputFile:m,unusedOutputFile:x}}catch(o){throw o}finally{await d.close()}}import{jsx as t,jsxs as i}from"react/jsx-runtime";function B(l,d=2){if(!+l)return"0 Bytes";let o=1024,c=d<0?0:d,e=["Bytes","KB","MB","GB","TB"],u=Math.floor(Math.log(l)/Math.log(o));return`${parseFloat((l/Math.pow(o,u)).toFixed(c))} ${e[u]}`}var U=({initialUrl:l})=>{let{exit:d}=P(),[o,c]=C(l||""),[e,u]=C(l?"SCANNING":"IDLE"),[s,g]=C(null),[m,x]=C(null);A(()=>{e==="SCANNING"&&(async()=>{try{let n=await R(o);g(n),u("SUCCESS")}catch(n){x(n.message||"An unknown error occurred"),u("ERROR")}})()},[e,o]);let h=p=>{if(!p.startsWith("http")){x("URL must start with http:// or https://");return}c(p),x(null),u("SCANNING")};if(e==="IDLE")return i(a,{flexDirection:"column",padding:1,children:[t(r,{color:"cyan",children:"Enter a website URL to scan for it's used and unused CSS:"}),t(a,{borderStyle:"round",borderColor:"blue",paddingX:1,children:t(M,{value:o,onChange:c,onSubmit:h,placeholder:"https://example.com"})}),m&&i(r,{color:"red",children:["Error: ",m]})]});if(e==="SCANNING")return t(a,{padding:1,children:i(r,{color:"yellow",children:[t(I,{type:"dots"})," Scanning ",t(r,{bold:!0,children:o})]})});if(e==="ERROR")return i(a,{flexDirection:"column",padding:1,children:[t(r,{color:"red",bold:!0,children:"\u274C Scan Failed"}),t(r,{children:m})]});if(e==="SUCCESS"&&s){let p=parseFloat(s.unusedPercentage),n=p>50?"red":"green";return i(a,{flexDirection:"column",padding:1,borderStyle:"single",borderColor:"gray",children:[t(a,{marginBottom:1,children:i(r,{bold:!0,underline:!0,children:["CSS Usage Metrics For: ",s.url]})}),t(a,{marginBottom:1,children:i(r,{color:"gray",children:["Scanned Viewports: ",s.scannedViewports.join(", ")]})}),i(a,{children:[t(a,{width:20,children:t(r,{children:"Used:"})}),t(r,{bold:!0,color:"green",children:B(s.usedBytes)})]}),i(a,{children:[t(a,{width:20,children:t(r,{children:"Unused:"})}),t(r,{bold:!0,color:n,children:B(s.unusedBytes)})]}),i(a,{children:[t(a,{width:20,children:t(r,{children:"Total:"})}),t(r,{bold:!0,children:B(s.totalBytes)})]}),i(a,{marginTop:1,children:[t(a,{width:20,children:t(r,{children:"Percentage:"})}),i(r,{bold:!0,color:n,backgroundColor:p>70?"#330000":void 0,children:[s.unusedPercentage,"%"]})]}),i(a,{marginTop:1,flexDirection:"column",borderStyle:"round",borderColor:"green",paddingX:1,children:[i(r,{children:["Exported Used CSS Code File: ",t(r,{bold:!0,color:"blue",children:s.outputFile})]}),i(r,{children:["Exported Unused CSS Code File: ",t(r,{bold:!0,color:"blue",children:s.unusedOutputFile})]})]})]})}return null};import{jsx as L}from"react/jsx-runtime";var k=O(`
	Usage
	  $ css-scan

	Options
	  --url, -u  The URL to scan immediately

	Examples
	  $ css-scan
	  $ css-scan --url https://google.com
`,{importMeta:import.meta,flags:{url:{type:"string",shortFlag:"u"}}});D(L(U,{initialUrl:k.flags.url}));
